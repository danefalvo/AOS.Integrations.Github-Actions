name: Github Actions Area of Speciality

env:
  OCTOPUS_API_KEY: ${{ secrets.OCTO_API_KEY }}
  OCTOPUS_HOST: ${{ secrets.OCTOPUS_HOST }}
  OCTOPUS_CLI_SERVER: ${{ secrets.OCTOPUS_HOST }}

  OCTOPUS_SPACE: 'Dane'      
  PACKAGENAME: 'Monday'

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "trigger" ]
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:

  build:
    runs-on: ubuntu-latest
    environment: AOS Example
#    runs-on: ${{ matrix.os }}
#    strategy:
#      matrix:
#        os: [ ubuntu-latest, windows-latest]
    steps:
    
      - name: checkout_repository
        uses: actions/checkout@v3
      #  with:
      #    version: 'latest'
      - name: Bump release version
      # https://github.com/marketplace/actions/increment-semantic-version
        id: bump_version
        uses: christian-draeger/increment-semantic-version@1.0.3
        with:
          current-version: '1.1.0'
          version-fragment: 'feature'
      - name: Create Package
        #if: matrix.os == 'ubuntu-latest'
        run: |
          dotnet new console --name $PACKAGENAME
      - name: Pack
        #if: matrix.os == 'ubuntu-latest'
        run: dotnet pack -v normal -c Release --no-restore --include-source -p:PackageVersion=${{ steps.bump_version.outputs.next-version }} ./$PACKAGENAME/*.csproj 
      - name: Upload Artifact
        #if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v3
        with:
          name: nupkg
          path: ./${{ PACKAGENAME }}/bin/Release/*.nupkg
          #path: ./${{ github.event.repository.name }}/bin/Release/*.nupkg
      - name: Move Artifact
        run: |
          mkdir -p ./package/
          mv ./$PACKAGENAME/bin/Release/*.nupkg ./package/
      - name: Set env
        run: |
          GITHUB_RUNTIME_PACKAGE_VERSION=$(ls ./package/*.nupkg | head -n 1)
          PACKAGEVERSION=$(echo $GITHUB_RUNTIME_PACKAGE_VERSION | grep -E "[0-9]+.[0-9]+.[0-9]+")
      - name: test
        run: echo $GITHUB_RUNTIME_PACKAGE_VERSION
          echo $PACKAGEVERSION
      - name: Commit Package
        run: |
          pwd
          git add ./package/*.nupkg
          git config --global user.name 'Dane Falvo'
          git config --global user.email 'danefalvo@gmail.com'
          git commit -am "Package Upload"
          git push


  # This workflow contains multiple jobs starting with "push_a_package"
  push_a_package:
    needs: build
    environment: AOS Example
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    steps:
    - name: Install Octopus CLI 🐙
      uses: OctopusDeploy/install-octopus-cli-action@v1
      with:
        version: '*'

    - name: list-octopusdeploy-deployments
      run: |      
        DeploymentList=$(octo list-deployments --server=${{ env.OCTOPUS_HOST }} --apiKey=${{ env.OCTOPUS_API_KEY }} --outputformat=json)
        echo ${DeploymentList} | jq '.[].Project.Id'
      # octo list-deployments --server=${{ env.OCTOPUS_HOST }} --apiKey=${{ env.OCTOPUS_API_KEY }}      
      # PWSHScript="\$RESULTS = octo list-deployments --server="${{ env.OCTOPUS_HOST }}" --apiKey="${{ env.OCTOPUS_API_KEY }}
      # echo ${PWSHScript} > ./project.ps1
      # PWSHScript="\$RESULTS"
      # echo ${PWSHScript} >> ./project.ps1
      # sudo pwsh ./project.ps1
      # VARIABLE="\$projects = dotnet-octo list-deployments --server='\${{ env.OCTOPUS_HOST }}' --apiKey='\${{ env.OCTOPUS_API_KEY }}'"
      # echo ${VARIABLE} > ./project.ps1
      # VARIABLE="\$projects.name"
      # echo ${VARIABLE} >> ./project.ps1
      # dotnet tool install Octopus.DotNet.Cli --global --version 4.39.1
      # shell: pwsh  

  do_things_with_a_project:
    
    needs: push_a_package
    runs-on: ubuntu-latest
    environment: AOS Example
    steps:
  
    - name: Install Octopus CLI 🐙
      uses: OctopusDeploy/install-octopus-cli-action@v1
      with:
        version: '*'
    

    - name: Create a release in Octopus Deploy 🐙
      uses: OctopusDeploy/create-release-action@v2
      with:
        project: 'Integrations.Github Actions'
        git_ref: 'main'

    - name: Push build information to Octopus Deploy 🐙
      uses: OctopusDeploy/push-build-information-action@v1
      with:
        packages: $PACKAGENAME
        version: $PACKAGEVERSION
        branch: 'main'


    - name: Run a runbook in Octopus Deploy 🐙
      uses: OctopusDeploy/run-runbook-action@v2
      with:
        environments: 'Test Environment'
        project: 'Test Project'
        runbook: 'Test Runbook'
