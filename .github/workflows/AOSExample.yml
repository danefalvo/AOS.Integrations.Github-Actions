name: Github Actions Area of Speciality

env:
  OCTOPUS_API_KEY: ${{ secrets.OCTO_API_KEY }}
  OCTOPUS_CLI_SERVER: ${{ secrets.OCTOPUS_HOST }}
  OCTOPUS_SPACE: 'Dane'      

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "trigger" ]
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:

  build:
    runs-on: ubuntu-latest
#    runs-on: ${{ matrix.os }}
#    strategy:
#      matrix:
#        os: [ ubuntu-latest, windows-latest]
    steps:
    
      - name: checkout_repository
        uses: actions/checkout@v3
        with:
          version: 'latest'
      - name: Bump release version
      # https://github.com/marketplace/actions/increment-semantic-version
        id: bump_version
        uses: christian-draeger/increment-semantic-version@1.0.3
        with:
          current-version: '1.1.0'
          version-fragment: 'feature'
      - name: Create Package
        #if: matrix.os == 'ubuntu-latest'
        run: dotnet new console --name ${{ github.event.repository.name }}
      - name: Pack
        #if: matrix.os == 'ubuntu-latest'
        run: dotnet pack -v normal -c Release --no-restore --include-symbols --include-source -p:PackageVersion=${{ steps.bump_version.outputs.next-version }} ./${{ github.event.repository.name }}/*.csproj 
      - name: Upload Artifact
        #if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v2
        with:
          name: nupkg
          path: ./${{ github.event.repository.name }}/bin/Release/*.nupkg
      - name: Move Artifact
        run: |
          mkdir -p ./package/
          mv ./${{ github.event.repository.name }}/bin/Release/*.nupkg ./package/
      - name: Commit Package
        run: |
          pwd
          git add ./package/*.nupkg
          git config --global user.name 'Dane Falvo'
          git config --global user.email 'danefalvo@gmail.com'
          git commit -am "Package Upload"
          git push


  # This workflow contains multiple jobs starting with "push_a_package"
  push_a_package:
    needs: build
    environment: AOS Example
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    steps:
    - name: Install Octopus CLI 🐙
      uses: OctopusDeploy/install-octopus-cli-action@v1
      with:
        version: '*'

    - name: list-octopusdeploy-deployments
      run: |
        VARIABLE="\$projects = dotnet octo list-deployments --server='\${{ env.OCTOPUS_CLI_SERVER }}' --apiKey='\${{ env.OCTOPUS_API_KEY }}'"
        echo ${VARIABLE} > ./project.ps1
        VARIABLE="\$projects.name"
        echo ${VARIABLE} >> ./project.ps1
        dotnet tool install Octopus.DotNet.Cli --global --version 4.39.1
        sudo pwsh ./project.ps1


      # shell: pwsh  

  do_things_with_a_project:
    needs: push_a_package
    runs-on: ubuntu-latest
    steps:
    - name: Create a release in Octopus Deploy 🐙
      uses: OctopusDeploy/create-release-action@v2
      with:
        project: 'MyProject'

    - name: Push build information to Octopus Deploy 🐙
      uses: OctopusDeploy/push-build-information-action@v1
      with:
        packages: |
          '<packageId1>'
        version: '<versionofpackages>'

    - name: Run a runbook in Octopus Deploy 🐙
      uses: OctopusDeploy/run-runbook-action@v2
      with:
        environments: 'Test Environment'
        project: 'Test Project'
        runbook: 'Test Runbook'
