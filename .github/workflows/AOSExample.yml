name: Github Actions Area of Speciality

env:
  OCTOPUS_API_KEY: ${{ secrets.OCTOPUS_API_KEY }}
  OCTOPUS_HOST: ${{ secrets.OCTOPUS_HOST }}
  OCTOPUS_SPACE: 'Dane'      

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "trigger" ]
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:

  build:
    runs-on: ubuntu-latest
#    runs-on: ${{ matrix.os }}
#    strategy:
#      matrix:
#        os: [ ubuntu-latest, windows-latest]
    steps:
      - name: Create Package
        #if: matrix.os == 'ubuntu-latest'
        run: dotnet new console --name {{ $PROJECT_NAME }} --no-restore
      - name: Pack
        #if: matrix.os == 'ubuntu-latest'
        run: dotnet pack -v normal -c Release --no-restore --include-symbols --include-source -p:PackageVersion=1.1.{{ $GITHUB_RUN_ATTEMPT }}src/$PROJECT_NAME/$PROJECT_NAME.*proj      
      - name: Upload Artifact
        #if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v2
        with:
          name: nupkg
          path: src/$PROJECT_NAME/$PROJECT_NAME/bin/Release/*.nupkg


  # This workflow contains multiple jobs starting with "push_a_package"
  push_a_package:
    needs: build
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    steps:
    - name: checkout_repository
      uses: actions/checkout@v3
      with:
          version: 'latest'
    
    - name: Install Octopus CLI üêô
      uses: OctopusDeploy/install-octopus-cli-action@v1
      with:
        version: 'latest'

    - name: Push a package to Octopus Deploy üêô
      uses: OctopusDeploy/push-package-action@v2
      with:
        packages: |
          package1.tar.gz
          package2.zip
          packages/**/*.


  do_things_with_a_project:
    needs: push_a_package
    runs-on: ubuntu-latest
    steps:
    - name: Create a release in Octopus Deploy üêô
      uses: OctopusDeploy/create-release-action@v2
      with:
        project: 'MyProject'

    - name: Push build information to Octopus Deploy üêô
      uses: OctopusDeploy/push-build-information-action@v1
      with:
        packages: |
          '<packageId1>'
        version: '<versionofpackages>'

    - name: Run a runbook in Octopus Deploy üêô
      uses: OctopusDeploy/run-runbook-action@v2
      with:
        environments: 'Test Environment'
        project: 'Test Project'
        runbook: 'Test Runbook'
